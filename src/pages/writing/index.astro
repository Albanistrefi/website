---
import Layout from '@/layouts/Layout.astro';
import { Header, Footer } from '@/components';
import { getCollection } from 'astro:content';
import { filterDrafts, sortPostsByDate, groupPostsByYear, formatDate } from '@/utils';

const allPosts = await getCollection('writing');
const posts = sortPostsByDate(filterDrafts(allPosts));
const postsByYear = groupPostsByYear(posts);
---

<Layout
  title="Writing - Alban Istrefi"
  description="Articles, tutorials, and thoughts on web development, design systems, and software engineering"
>
  <Header />

  <main class="page-shell mx-auto max-w-[900px]">
    <div class="mb-12 mt-8 space-y-2">
      <h1 class="text-[1.5rem] leading-[1.3] -tracking-[0.02em] lg:text-[2rem] lg:leading-[1.2] font-semibold">
        Writing
      </h1>
    </div>

    {Object.entries(postsByYear)
      .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
      .map(([year, yearPosts]) => (
        <section class="mb-16" id={`posts-${year}`}>
          <h2 class="text-sm font-medium uppercase tracking-wide text-text-tertiary mb-8 border-b border-border pb-2">
            {year}
          </h2>

          <ul class="flex flex-col">
            {yearPosts.map((post) => {
              const publishDate = post.data.publishDate;
              const formattedDate = formatDate(publishDate);
              const month = formatDate(publishDate, 'MMMM');
              const yearValue = publishDate.getFullYear();
              const tags = post.data.tags ?? [];
              const transitionId = `post-heading-${post.slug}`;

              return (
                <li class="group grid grid-cols-1 lg:grid-cols-[2fr_3fr] lg:gap-8 border-t border-border py-8 first:border-t-0">
                  
                  {/* Left: Date */}
                  <div class="flex flex-row lg:flex-col items-center lg:items-start gap-2 lg:gap-1 text-sm font-mono text-text-tertiary mb-4 lg:mb-0 lg:pr-8 h-full">
                    <span class="font-medium text-text-secondary">{month}</span>
                    <span class="text-text-muted">{yearValue}</span>
                  </div>

                  {/* Right: Content */}
                  <div class="flex flex-col gap-2">
                    <a
                      href={`/writing/${post.slug}`}
                      class="block group-hover:opacity-80 transition-opacity duration-200"
                    >
                      <h3
                        class="text-xl font-medium text-text-primary decoration-dashed underline-offset-4 group-hover:text-accent-primary transition-colors"
                        transition:name={transitionId}
                      >
                        {post.data.title}
                      </h3>
                    </a>

                    <div class="text-xs font-mono text-text-tertiary">
                      {formattedDate}{tags.length > 0 && ` | ${tags.map(tag => `#${tag}`).join(', ')}`}
                    </div>
                  </div>

                </li>
              );
            })}
          </ul>
        </section>
      ))}

    {posts.length === 0 && (
      <div class="text-center py-12 text-text-secondary">
        No posts yet. Check back soon!
      </div>
    )}
  </main>

  <Footer />
</Layout>
