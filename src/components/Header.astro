---
import { Link } from './Link';
import { SearchIcon, SunIcon, MoonIcon } from './Icons';
import { Image } from 'astro:assets';
import aIcon from '../assets/A.png';

interface Props {
  class?: string;
  animateTitle?: boolean;
}

const { class: className, animateTitle = false } = Astro.props;
---
<header data-site-header class={`sticky top-0 w-full z-[1000] ${className || ''}`}>
  {/* Actual Header Bar Background - Surgical separation to allow solid drawer */}
  <div class="absolute inset-0 h-full bg-background-primary/80 backdrop-blur-md border-b border-border/50 pointer-events-none"></div>

  <div class="relative max-w-[900px] mx-auto py-4 md:py-6 px-4 md:px-0">
    <nav class="flex items-center justify-between" role="navigation" aria-label="Main navigation">
      {/* Logo/Site Title - Always on the left */}
      <div class="flex-shrink-0 flex items-center">
        <Link
          href="/"
          variant="unstyled"
          className="text-text-primary font-medium text-base lg:text-lg hover:text-accent-primary transition-colors duration-200 site-title-link flex items-center gap-1.5"
          aria-label="Home"
        >
          <span class="sr-only">Alban Istrefi</span>
          <Image src={aIcon} alt="Alban Istrefi Logo" width={64} height={64} class="w-8 h-8 object-contain brightness-0 invert [.theme-light_&]:brightness-100 [.theme-light_&]:invert-0" format="png" quality={100} />
          <span
            aria-hidden="true"
            class={`header-title-anim ${animateTitle ? '' : 'header-title-anim--static'}`.trim()}
          >
            <span class="header-title-anim__row">
              <span class="header-title-anim__block header-title-anim__block--primary"></span>
              <span class="header-title-anim__text uppercase">
                ALBANISTREFI
                <span class="header-title-anim__dot"></span>
              </span>
            </span>
          </span>
        </Link>
      </div>

      {/* Desktop Right Items: links + icons */}
      <div class="hidden md:flex items-center justify-end">
        <div class="flex items-center space-x-6">
          <Link
            href="/writing"
            variant="navigation"
            class="text-[0.9375rem]"
          >
            Writing
          </Link>
          <Link
            href="/about"
            variant="navigation"
            class="text-[0.9375rem]"
          >
            About
          </Link>
        </div>
        <div class="flex items-center justify-center space-x-4 pl-4 ml-4 border-l border-border">
          <button
            type="button"
            class="inline-flex items-center justify-center leading-none focus:outline-none focus:ring-2 focus:ring-accent-primary focus:ring-offset-2 focus:ring-offset-background-primary rounded"
            aria-label="Search site"
          >
            <SearchIcon size="1.25rem" />
          </button>
          <button
            id="theme-toggle-desktop"
            type="button"
            class="theme-toggle group relative inline-flex h-8 w-16 items-center rounded-full border-2 border-border bg-background-secondary transition-all hover:border-accent-primary focus:outline-none"
            aria-label="Switch to light theme"
            aria-pressed="false"
          >
            <span class="sr-only">Toggle theme</span>
            
            {/* Sliding Thumb Circle */}
            <span
              class="theme-toggle-thumb pointer-events-none absolute left-1 top-[2px] h-6 w-6 rounded-full bg-white shadow-md transition-all duration-300 ease-in-out z-10"
            ></span>

            {/* Icons - Precisely positioned to match thumb centers */}
            <div class="absolute inset-0 z-20 pointer-events-none flex items-center">
              <div class="sun-icon-wrapper absolute left-[9px] transition-colors duration-300">
                <SunIcon size="0.875rem" />
              </div>
              <div class="moon-icon-wrapper absolute right-[9px] transition-colors duration-300">
                <MoonIcon size="0.875rem" />
              </div>
            </div>
          </button>
        </div>
      </div>

      {/* Mobile Menu Button - Moved back to the right */}
      <button
        id="mobile-menu-button"
        class="md:hidden relative z-[1100] p-2 -mr-2 text-text-primary hover:text-accent-primary transition-colors duration-200 focus:outline-none"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path id="menu-icon-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </nav>
  </div>

  {/* Mobile Menu Drawer Overlay - Solid, high-z overlay */}
  <div
    id="mobile-menu-overlay"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1050] opacity-0 pointer-events-none invisible transition-all duration-300 md:hidden"
    aria-hidden="true"
  ></div>

  {/* Mobile Menu Drawer - Slide from LEFT, Full Width */}
  <div
    id="mobile-menu"
    class="fixed top-0 left-0 bottom-0 w-full bg-[#000000] [.theme-light_&]:bg-[#ffffff] z-[1080] -translate-x-full invisible transition-all duration-300 ease-in-out md:hidden shadow-2xl"
    aria-hidden="true"
  >
    <div class="flex flex-col h-full p-8 pt-24 max-w-[400px] mx-auto">
      {/* Mobile Navigation Links */}
      <nav class="flex flex-col space-y-1">
        <a
          href="/writing"
          class="flex items-center justify-between py-6 border-b border-border/50 text-2xl font-medium text-text-primary group mobile-menu-link"
        >
          <span>Writing</span>
          <svg class="w-6 h-6 text-text-muted group-hover:text-accent-primary transition-colors shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </a>
        <a
          href="/about"
          class="flex items-center justify-between py-6 border-b border-border/50 text-2xl font-medium text-text-primary group mobile-menu-link"
        >
          <span>About</span>
          <svg class="w-6 h-6 text-text-muted group-hover:text-accent-primary transition-colors shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </a>
      </nav>

      <div class="mt-auto mb-8">
         <h2 class="text-[10px] font-bold uppercase tracking-widest text-text-tertiary mb-6">
          Preferences & Search
        </h2>
        
        <div class="space-y-4">
          <div class="flex items-center justify-between p-4 bg-background-secondary rounded-2xl border border-border/50">
            <span class="text-sm font-medium text-text-secondary">Theme</span>
             <button
              id="theme-toggle-mobile"
              type="button"
              class="theme-toggle group relative inline-flex h-8 w-16 items-center rounded-full border-2 border-border bg-background-primary transition-all focus:outline-none"
              aria-label="Switch to light theme"
              aria-pressed="false"
            >
              <span class="sr-only">Toggle theme</span>
              <span
                class="theme-toggle-thumb pointer-events-none absolute left-1 top-[2px] h-6 w-6 rounded-full bg-white shadow-md transition-all duration-300 ease-in-out z-10"
              ></span>
              <div class="absolute inset-0 z-20 pointer-events-none flex items-center">
                <div class="sun-icon-wrapper absolute left-[9px] transition-colors duration-300">
                  <SunIcon size="0.875rem" />
                </div>
                <div class="moon-icon-wrapper absolute right-[9px] transition-colors duration-300">
                  <MoonIcon size="0.875rem" />
                </div>
              </div>
            </button>
          </div>

          <button
            type="button"
            class="flex items-center justify-between p-4 bg-background-secondary rounded-2xl border border-border/50 text-text-secondary hover:text-accent-primary transition-colors w-full group"
            aria-label="Search site"
          >
            <div class="flex items-center gap-3">
              <SearchIcon size="1.25rem" />
              <span class="text-base font-medium">Search</span>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>
</header>

<script is:inline>
  (() => {
    const updateThemeToggleState = (buttons, isLight, shouldAnimate = true) => {
      buttons.forEach((btn) => {
        btn.setAttribute('aria-pressed', String(isLight));
        btn.setAttribute('aria-label', isLight ? 'Switch to dark theme' : 'Switch to light theme');
        
        const thumb = btn.querySelector('.theme-toggle-thumb');
        const sunWrapper = btn.querySelector('.sun-icon-wrapper');
        const moonWrapper = btn.querySelector('.moon-icon-wrapper');

        if (thumb) {
          if (!shouldAnimate) {
            thumb.style.transition = 'none';
          }

          // Simple translateX logic
          thumb.style.transform = isLight ? 'translateX(0)' : 'translateX(1.75rem)';
          
          thumb.style.backgroundColor = isLight ? 'var(--color-border)' : '#ffffff';
          thumb.style.border = 'none';

          if (!shouldAnimate) {
            void thumb.offsetWidth;
            thumb.style.transition = '';
          }
        }

        if (sunWrapper && moonWrapper) {
          sunWrapper.style.color = isLight ? '#ffffff' : 'var(--color-text-muted)';
          moonWrapper.style.color = isLight ? 'var(--color-text-muted)' : '#000000';
        }
      });
    };

    const getStoredThemePreference = () => {
      try {
        const stored = localStorage.getItem('theme');
        if (stored === 'light') return true;
        if (stored === 'dark') return false;
      } catch (_) {
        return document.documentElement.classList.contains('theme-light');
      }

      return window.matchMedia('(prefers-color-scheme: light)').matches;
    };

    const applyThemeClass = (isLight, options = {}) => {
      const root = document.documentElement;
      root.classList.toggle('theme-light', isLight);
    };

    const setTheme = (buttons, isLight, options = {}) => {
      const { persist = true, animate = true } = options;
      applyThemeClass(isLight, { animate });
      if (persist) {
        try {
          localStorage.setItem('theme', isLight ? 'light' : 'dark');
        } catch (_) {
          /* ignore */
        }
      }
      updateThemeToggleState(buttons, isLight, animate);
    };

    const hydrateThemePreference = (buttons) => {
      const isLight = getStoredThemePreference();
      setTheme(buttons, isLight, { persist: false, animate: false });
    };

    const initHeaderInteractions = () => {
      const header = document.querySelector('[data-site-header]');
      if (!header || header.dataset.interactionsInitialized === 'true') return;
      header.dataset.interactionsInitialized = 'true';

      const menuButton = header.querySelector('#mobile-menu-button');
      const mobileMenu = header.querySelector('#mobile-menu');
      const overlay = header.querySelector('#mobile-menu-overlay');

      if (menuButton && mobileMenu && overlay) {
        const toggleMenu = (open) => {
          menuButton.setAttribute('aria-expanded', String(open));
          mobileMenu.setAttribute('aria-hidden', String(!open));
          overlay.setAttribute('aria-hidden', String(!open));
          
          if (open) {
            mobileMenu.classList.remove('-translate-x-full', 'invisible');
            overlay.classList.remove('opacity-0', 'pointer-events-none', 'invisible');
            document.body.style.overflow = 'hidden';
          } else {
            mobileMenu.classList.add('-translate-x-full');
            overlay.classList.add('opacity-0', 'pointer-events-none');
            document.body.style.overflow = '';
            
            setTimeout(() => {
              if (menuButton.getAttribute('aria-expanded') === 'false') {
                mobileMenu.classList.add('invisible');
                overlay.classList.add('invisible');
              }
            }, 300);
          }

          const path = menuButton.querySelector('#menu-icon-path');
          if (path) {
            path.setAttribute('d', open 
              ? 'M6 18L18 6M6 6l12 12' 
              : 'M4 6h16M4 12h16M4 18h16');
          }
        };

        menuButton.addEventListener('click', () => {
          const isExpanded = menuButton.getAttribute('aria-expanded') === 'true';
          toggleMenu(!isExpanded);
        });

        overlay.addEventListener('click', () => toggleMenu(false));

        mobileMenu.querySelectorAll('.mobile-menu-link').forEach((link) => {
          link.addEventListener('click', () => toggleMenu(false));
        });
      }

      const themeToggleButtons = header.querySelectorAll('.theme-toggle');

      if (themeToggleButtons.length > 0) {
        hydrateThemePreference(themeToggleButtons);
        themeToggleButtons.forEach((btn) => {
          btn.addEventListener('click', () => {
            const nextIsLight = !document.documentElement.classList.contains('theme-light');
            setTheme(themeToggleButtons, nextIsLight);
          });
        });
      }
    };

    const scheduleInit = () => window.requestAnimationFrame(initHeaderInteractions);

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', scheduleInit, { once: true });
    } else {
      scheduleInit();
    }

    document.addEventListener('astro:page-load', scheduleInit);
  })();
</script>